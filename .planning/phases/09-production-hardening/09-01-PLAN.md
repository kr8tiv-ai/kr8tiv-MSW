---
phase: 09-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/logging/index.ts
  - src/logging/logger.ts
  - src/logging/transports.ts
  - src/logging/levels.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Structured logs are written to .msw/logs/ with daily rotation"
    - "Log level can be configured via MSW_LOG_LEVEL environment variable"
    - "Logs are written to stderr in development (never stdout for MCP safety)"
    - "Sensitive fields (password, token, cookie) are automatically redacted"
  artifacts:
    - path: "src/logging/logger.ts"
      provides: "Pino logger factory with child logger support"
      exports: ["logger", "createLogger"]
    - path: "src/logging/transports.ts"
      provides: "Worker thread transport configuration"
      exports: ["createTransport"]
    - path: "src/logging/levels.ts"
      provides: "Log level configuration utilities"
      exports: ["LOG_LEVELS", "getLogLevel"]
    - path: "src/logging/index.ts"
      provides: "Barrel export for logging module"
      exports: ["logger", "createLogger", "LOG_LEVELS"]
  key_links:
    - from: "src/logging/logger.ts"
      to: "pino"
      via: "import and configuration"
      pattern: "import pino from \"pino\""
    - from: "src/logging/transports.ts"
      to: "pino-roll"
      via: "worker thread transport target"
      pattern: "target: \"pino-roll\""
---

<objective>
Implement structured logging infrastructure using Pino with log rotation via pino-roll.

Purpose: Enable production-grade logging that writes to `.msw/logs/` with automatic rotation, configurable log levels, and MCP-safe output (stderr only, never stdout).

Output: Complete logging module (`src/logging/`) with Pino logger, worker thread transports, and child logger factory for component-specific logging.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-production-hardening/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Pino logging dependencies</name>
  <files>package.json</files>
  <action>
Install production logging dependencies:
- `pino` ^9.x - Core structured logging
- `pino-roll` ^2.x - Worker thread log rotation transport

Install dev dependencies:
- `pino-pretty` ^13.x - Human-readable development output

Run: `npm install pino pino-roll && npm install -D pino-pretty`

NOTE: Do NOT install @types/pino - Pino 9.x includes built-in TypeScript definitions.
  </action>
  <verify>
- `npm ls pino` shows pino@^9.x installed
- `npm ls pino-roll` shows pino-roll@^2.x installed
- `npm ls pino-pretty` shows pino-pretty@^13.x in devDependencies
  </verify>
  <done>Pino and pino-roll are installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Implement Pino logger module with MCP-safe configuration</name>
  <files>
    src/logging/levels.ts
    src/logging/transports.ts
    src/logging/logger.ts
    src/logging/index.ts
  </files>
  <action>
Create `src/logging/` directory with four files:

**src/logging/levels.ts:**
```typescript
// Log level configuration (HARD-08)
export const LOG_LEVELS = {
  error: 50,
  warn: 40,
  info: 30,
  debug: 20,
  trace: 10,
} as const;

export type LogLevel = keyof typeof LOG_LEVELS;

export function getLogLevel(): LogLevel {
  const envLevel = process.env.MSW_LOG_LEVEL?.toLowerCase();
  if (envLevel && envLevel in LOG_LEVELS) {
    return envLevel as LogLevel;
  }
  return "info"; // Default
}
```

**src/logging/transports.ts:**
```typescript
import pino from "pino";
import { join } from "node:path";
import { getLogLevel } from "./levels.js";

// CRITICAL: MCP servers must NOT write to stdout (fd 1)
// stdout is reserved for JSON-RPC communication
// Use stderr (fd 2) and files ONLY

export function createTransport() {
  const level = getLogLevel();
  const logDir = join(process.cwd(), ".msw/logs");

  return pino.transport({
    targets: [
      // File transport with rotation (HARD-07)
      {
        target: "pino-roll",
        level,
        options: {
          file: join(logDir, "msw"),
          frequency: "daily",    // Rotate daily
          size: "10m",           // Or when file reaches 10MB
          limit: { count: 7 },   // Keep 7 rotated files + current
          dateFormat: "yyyy-MM-dd",
          mkdir: true,           // Create directory if missing
          extension: ".log",
        },
      },
      // Stderr for development visibility (MCP-safe)
      {
        target: "pino/file",
        level,
        options: { destination: 2 }, // fd 2 = stderr
      },
    ],
  });
}
```

**src/logging/logger.ts:**
```typescript
import pino from "pino";
import { getLogLevel } from "./levels.js";
import { createTransport } from "./transports.js";

// Create the base logger instance
export const logger = pino(
  {
    level: getLogLevel(),
    // Structured logging base fields
    base: {
      service: "msw-protocol",
      version: process.env.npm_package_version || "0.0.0",
    },
    // ISO timestamp format
    timestamp: pino.stdTimeFunctions.isoTime,
    // Redact sensitive fields (security best practice)
    redact: {
      paths: [
        "password",
        "token",
        "cookie",
        "secret",
        "authorization",
        "*.password",
        "*.token",
        "*.cookie",
        "*.secret",
        "headers.authorization",
        "headers.cookie",
      ],
      censor: "[REDACTED]",
    },
  },
  createTransport()
);

/**
 * Create a child logger for a specific component.
 * Adds `component` field to all log entries.
 *
 * @example
 * const log = createLogger("browser-driver");
 * log.info({ url }, "Navigating to page");
 */
export function createLogger(component: string) {
  return logger.child({ component });
}
```

**src/logging/index.ts:**
```typescript
// Barrel export for logging module
export { logger, createLogger } from "./logger.js";
export { LOG_LEVELS, getLogLevel, type LogLevel } from "./levels.js";
export { createTransport } from "./transports.js";
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `ls src/logging/` shows 4 files (index.ts, logger.ts, transports.ts, levels.ts)
- Run test: `MSW_LOG_LEVEL=debug node --loader ts-node/esm -e "import { logger, createLogger } from './src/logging/index.js'; logger.info('test'); createLogger('test').debug({ key: 'value' }, 'child logger');"` - should output structured JSON to stderr
  </verify>
  <done>
- Logger writes structured JSON to .msw/logs/msw-YYYY-MM-DD.log with rotation
- MSW_LOG_LEVEL environment variable controls log verbosity
- createLogger() produces child loggers with component field
- Sensitive fields are redacted in output
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run `npm run build` (or `npx tsc`) - should complete without errors
2. Set `MSW_LOG_LEVEL=debug` and run a simple test - debug logs should appear
3. Check `.msw/logs/` directory is created with log file
4. Verify password/token fields are redacted when logged
</verification>

<success_criteria>
- Pino and pino-roll installed in package.json
- src/logging/ module exports logger, createLogger, LOG_LEVELS
- Logs written to .msw/logs/ with daily rotation
- Log level configurable via MSW_LOG_LEVEL (debug, info, warn, error)
- No output to stdout (MCP-safe)
- Sensitive fields automatically redacted
</success_criteria>

<output>
After completion, create `.planning/phases/09-production-hardening/09-01-SUMMARY.md`
</output>
