# Plan: Production Infrastructure Integration

**Phase:** 9 (Production Hardening)
**Plan ID:** 09-07
**Wave:** 4 (depends on 09-01 through 09-06)
**Estimate:** 20 minutes

## Goal

Integrate all Phase 9 production infrastructure modules (logging, rate limiting, setup wizard, diagnostics, metrics, session management) into the application to achieve the phase goal: "Harden MSW for production use with comprehensive logging, rate limiting, graceful degradation, and operational tools."

## Success Criteria

- [ ] Logging module imported and used by browser automation components
- [ ] QuotaTracker instantiated and enforcing NotebookLM rate limits
- [ ] Setup wizard accessible via CLI entry point (bin/msw.js)
- [ ] Health checks run before browser launch with auto-fix
- [ ] Performance metrics track NotebookLM queries and browser operations
- [ ] Session manager tracks long-running operations with crash resumption

## Tasks

### Task 1: Integrate Logging Infrastructure (6 min)

**What:** Wire structured logging into existing application components

**Changes:**
1. Export logger from `src/index.ts`
2. Add logging to `src/browser/driver.ts`:
   - Log browser launch/close events
   - Log profile lock detection
   - Use child logger: `createLogger('browser-driver')`
3. Add logging to `src/browser/navigator.ts`:
   - Log navigation events
   - Log selector failures
   - Use child logger: `createLogger('notebook-navigator')`
4. Add logging to `src/browser/extractor.ts`:
   - Log response extraction start/complete
   - Use child logger: `createLogger('response-extractor')`

**Verification:**
```bash
# Check logger is imported
grep -r "from.*logging" src/browser/

# Run and check stderr output (logs should appear)
MSW_LOG_LEVEL=debug npm run build && node dist/index.js 2>&1 | grep -i "browser"
```

**Commit:** `feat(09-07): integrate structured logging into browser automation`

---

### Task 2: Integrate Rate Limiting (4 min)

**What:** Enforce NotebookLM quota tracking in query flow

**Changes:**
1. Export QuotaTracker from `src/index.ts`
2. Modify `src/browser/navigator.ts`:
   - Instantiate global QuotaTracker at module level
   - Call `tracker.canRequest()` before `submitQuery()`
   - Throw descriptive error if quota exceeded
   - Call `tracker.recordRequest()` after successful query
3. Add usage dashboard to smoke test script:
   - Import `displayUsageDashboard()` in `scripts/smoke-test.ts`
   - Display usage after test completes

**Verification:**
```bash
# Check QuotaTracker is instantiated
grep "new QuotaTracker" src/browser/navigator.ts

# Check quota file created
ls -la .msw/quota.json
```

**Commit:** `feat(09-07): integrate rate limiting into NotebookLM query flow`

---

### Task 3: Create CLI Entry Point with Setup Wizard (5 min)

**What:** Make setup wizard accessible via npx/global install

**Changes:**
1. Create `bin/msw.js` (Node.js shebang script):
   ```javascript
   #!/usr/bin/env node
   import { isFirstRun, runSetupWizard } from '../dist/demo/index.js';

   async function main() {
     if (isFirstRun()) {
       console.log('ðŸš€ Welcome to MSW! Running first-time setup...\n');
       await runSetupWizard();
     } else {
       console.log('âœ… MSW is already configured. Run "npx msw config" to reconfigure.');
     }
   }

   main().catch(console.error);
   ```
2. Make executable: `chmod +x bin/msw.js`
3. Add to `package.json`:
   ```json
   "bin": {
     "msw": "./bin/msw.js"
   }
   ```
4. Export demo module from `src/index.ts`

**Verification:**
```bash
# Test CLI entry point
node bin/msw.js

# Should show wizard on first run or confirmation on subsequent runs
```

**Commit:** `feat(09-07): add CLI entry point with first-run setup wizard`

---

### Task 4: Integrate Health Checks and Auto-Fix (3 min)

**What:** Run diagnostics before browser launch with automatic remediation

**Changes:**
1. Export diagnostics from `src/index.ts`
2. Modify `src/browser/driver.ts`:
   - Import `runHealthCheck()` and `AutoFixer`
   - Call `runHealthCheck()` at start of `launch()` method
   - If status is 'unhealthy', throw descriptive error
   - Log health check results (info level)

**Verification:**
```bash
# Create stale lock file
touch ~/.msw/chrome-profile/SingletonLock

# Run smoke test (should auto-clear lock)
npm run smoke-test 2>&1 | grep -i "health"
```

**Commit:** `feat(09-07): integrate health checks and auto-fix into browser driver`

---

### Task 5: Integrate Performance Metrics (2 min)

**What:** Measure NotebookLM queries and browser operations

**Changes:**
1. Export MetricsCollector from `src/index.ts`
2. Modify `src/browser/navigator.ts`:
   - Import `getMetricsCollector()`
   - Wrap `submitQuery()` with `metrics.measureAsync('notebooklm.query', ...)`
   - Wrap `waitForResponse()` with `metrics.measureAsync('notebooklm.response', ...)`
3. Modify `src/browser/driver.ts`:
   - Wrap `launch()` with `metrics.measureAsync('browser.launch', ...)`

**Verification:**
```bash
# Run smoke test
npm run smoke-test

# Check metrics exported
ls -la .msw/metrics-*.json

# View metrics
cat .msw/metrics-*.json | jq '.metrics'
```

**Commit:** `feat(09-07): integrate performance metrics tracking`

---

## Dependencies

**Before this plan:**
- 09-01 (Logging infrastructure)
- 09-02 (Rate limiting)
- 09-03 (Demo mode)
- 09-04 (Self-healing)
- 09-05 (Performance metrics)
- 09-06 (Session management)

**After this plan:**
- Phase 9 verification (all gaps closed)

## Key Links

- [Logging module](../../../src/logging/)
- [Rate limiting](../../../src/rate-limiting/)
- [Demo mode](../../../src/demo/)
- [Diagnostics](../../../src/diagnostics/)
- [Metrics](../../../src/metrics/)
- [BrowserDriver](../../../src/browser/driver.ts)
- [NotebookNavigator](../../../src/browser/navigator.ts)

## Verification

After all tasks:

1. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```

2. **Integration verification:**
   ```bash
   # All modules should be imported from src/index.ts
   grep "export.*from.*logging" src/index.ts
   grep "export.*from.*rate-limiting" src/index.ts
   grep "export.*from.*demo" src/index.ts
   grep "export.*from.*diagnostics" src/index.ts
   grep "export.*from.*metrics" src/index.ts

   # CLI entry point works
   node bin/msw.js

   # Smoke test runs with all integrations
   npm run smoke-test 2>&1 | grep -E "(logger|quota|health|metrics)"
   ```

3. **Verification criteria from VERIFICATION.md:**
   - âœ… Logger imported in src/browser/driver.ts, navigator.ts, extractor.ts
   - âœ… QuotaTracker instantiated in navigator.ts with canRequest()/recordRequest() calls
   - âœ… bin/msw.js CLI entry point created with package.json bin field
   - âœ… runHealthCheck() called in driver.ts before browser launch
   - âœ… MetricsCollector measures queries, responses, and browser launch
   - âœ… (Session management integration deferred - no long-running operations yet)

## Notes

- Session management (09-06) integration deferred until Phase 2 (Auto-Conversation Engine) implements multi-level expansion
- All other Phase 9 modules will be fully integrated after this plan
- Phase 9 re-verification should pass after this plan completes
