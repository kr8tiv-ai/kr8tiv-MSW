---
phase: 02-auto-conversation-engine
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03", "02-04"]
files_modified:
  - src/auto-conversation/engine.ts
  - src/auto-conversation/index.ts
autonomous: true

must_haves:
  truths:
    - "TopicExpansionEngine orchestrates full BFS expansion: detect pills -> score -> click -> extract -> repeat"
    - "Expansion respects budget limits and stops when budget exhausted or no more topics"
    - "Expansion respects maxLevel depth limit (default 10)"
    - "High-scoring topics are expanded before low-scoring ones at any level"
    - "Engine logs progress: topics expanded, budget remaining, current level"
  artifacts:
    - path: "src/auto-conversation/engine.ts"
      provides: "TopicExpansionEngine orchestrating the full BFS loop"
      exports: ["TopicExpansionEngine"]
    - path: "src/auto-conversation/index.ts"
      provides: "Barrel exports for auto-conversation module"
      exports: ["TopicExpansionEngine", "TopicDetector", "RelevanceScorer", "BudgetTracker", "TopicClicker", "ExpansionState"]
  key_links:
    - from: "src/auto-conversation/engine.ts"
      to: "src/auto-conversation/topic-detector.ts"
      via: "import TopicDetector"
      pattern: "import.*topic-detector"
    - from: "src/auto-conversation/engine.ts"
      to: "src/auto-conversation/relevance-scorer.ts"
      via: "import RelevanceScorer"
      pattern: "import.*relevance-scorer"
    - from: "src/auto-conversation/engine.ts"
      to: "src/auto-conversation/budget-tracker.ts"
      via: "import BudgetTracker"
      pattern: "import.*budget-tracker"
    - from: "src/auto-conversation/engine.ts"
      to: "src/auto-conversation/topic-clicker.ts"
      via: "import TopicClicker"
      pattern: "import.*topic-clicker"
    - from: "src/auto-conversation/engine.ts"
      to: "src/auto-conversation/expansion-state.ts"
      via: "import ExpansionState"
      pattern: "import.*expansion-state"
---

<objective>
Implement the TopicExpansionEngine that orchestrates the full BFS topic expansion loop, combining all Phase 2 components into the core auto-conversation pipeline.

Purpose: This is THE deliverable of Phase 2 — the engine that automatically explores NotebookLM's suggested topics with relevance filtering and budget awareness.
Output: Working TopicExpansionEngine and barrel exports for the module.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-auto-conversation-engine/02-RESEARCH.md
@.planning/phases/02-auto-conversation-engine/02-01-SUMMARY.md
@.planning/phases/02-auto-conversation-engine/02-02-SUMMARY.md
@.planning/phases/02-auto-conversation-engine/02-03-SUMMARY.md
@.planning/phases/02-auto-conversation-engine/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TopicExpansionEngine</name>
  <files>src/auto-conversation/engine.ts</files>
  <action>
Create TopicExpansionEngine class that orchestrates the BFS expansion loop.

**Constructor:** Takes `{ page: Page, config: ExpansionConfig }`.

Internally creates instances of:
- TopicDetector(page)
- RelevanceScorer({ model: config.model })
- BudgetTracker({ dailyLimit: config.maxQueries })
- TopicClicker(page)
- ExpansionState(config)

**`initialize(): Promise<void>`:**
1. Call `this.scorer.initialize()` (verifies Ollama, warms model)
2. Log "TopicExpansionEngine ready"

**`run(): Promise<ExpansionResult>`:** The main BFS loop:
1. **Seed phase:** Detect initial topic pills via TopicDetector. Score each with RelevanceScorer. Enqueue those above threshold into ExpansionState.
2. **Expansion loop:** While `state.canContinue() && budget.canQuery()`:
   a. Dequeue highest-score topic from state
   b. If null (queue empty), break
   c. If topic level > maxLevel, skip and continue
   d. Log: "Expanding [level N]: {topicText} (score: X)"
   e. If budget.isNearLimit(), log budget warning via budget.getWarning()
   f. Mark topic as visited in state
   g. Consume one query from budget
   h. Click topic and extract response via TopicClicker
   i. Store response in state
   j. Detect new pills via TopicDetector.detectNewPills(state.visited)
   k. Score each new pill with RelevanceScorer
   l. Enqueue scored pills above threshold
   m. Log stats: state.getStats()
3. **Completion:** Log summary (topics expanded, budget remaining, max level reached). Return state.getResult().

**`stop(): void`:** Set a `this.stopped = true` flag checked in the loop. Allows graceful early termination.

**Error handling:** Wrap the loop body in try/catch. If a single topic click fails, log the error and continue to the next topic (don't abort the whole expansion). Track errors in a `failures: Map<string, string>` for reporting.

Keep the expansion loop readable — it's the core algorithm. Use descriptive variable names, not abbreviations.
  </action>
  <verify>`npx tsc --noEmit src/auto-conversation/engine.ts` compiles</verify>
  <done>TopicExpansionEngine runs full BFS expansion: seed -> score -> click -> extract -> discover -> repeat</done>
</task>

<task type="auto">
  <name>Task 2: Barrel exports</name>
  <files>src/auto-conversation/index.ts</files>
  <action>
Create barrel export file for the auto-conversation module:

```typescript
export { TopicExpansionEngine } from './engine';
export { TopicDetector, normalizeTopic } from './topic-detector';
export { RelevanceScorer } from './relevance-scorer';
export { BudgetTracker } from './budget-tracker';
export { TopicClicker } from './topic-clicker';
export { ExpansionState } from './expansion-state';
export type { Topic, ScoredTopic, ExpansionConfig, ExpansionResult, BudgetState } from './types';
```
  </action>
  <verify>`npx tsc --noEmit src/auto-conversation/index.ts` compiles</verify>
  <done>All Phase 2 exports accessible from single import path</done>
</task>

</tasks>

<verification>
- All files in src/auto-conversation/ compile without errors
- `npx tsc --noEmit` passes for entire project
- TopicExpansionEngine imports all 5 component classes
- Barrel index exports all public APIs
- Engine handles individual topic failures gracefully (logs + continues)
</verification>

<success_criteria>
The full auto-conversation expansion pipeline is assembled and compilable. Engine orchestrates detect -> score -> click -> extract -> discover in a BFS loop with budget awareness.
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-conversation-engine/02-05-SUMMARY.md`
</output>
