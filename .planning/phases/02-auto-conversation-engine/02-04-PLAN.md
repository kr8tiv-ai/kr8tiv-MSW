---
phase: 02-auto-conversation-engine
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/auto-conversation/expansion-state.ts
autonomous: true

must_haves:
  truths:
    - "ExpansionState tracks visited topics, pending queue, and collected responses"
    - "Queue is priority-sorted by relevance score (highest first)"
    - "Duplicate topics are rejected via normalized text comparison"
  artifacts:
    - path: "src/auto-conversation/expansion-state.ts"
      provides: "ExpansionState class managing BFS queue and visited set"
      exports: ["ExpansionState"]
  key_links:
    - from: "src/auto-conversation/expansion-state.ts"
      to: "src/auto-conversation/types.ts"
      via: "import Topic, ScoredTopic types"
      pattern: "import.*types"
---

<objective>
Implement the ExpansionState that manages the BFS priority queue, visited set, and response collection for multi-level topic expansion.

Purpose: This is the data structure backbone of the expansion engine — it ensures topics are expanded in priority order, duplicates are skipped, and all results are collected.
Output: ExpansionState class with priority queue and deduplication.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-auto-conversation-engine/02-RESEARCH.md
@.planning/phases/02-auto-conversation-engine/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ExpansionState implementation</name>
  <files>src/auto-conversation/expansion-state.ts</files>
  <action>
Create ExpansionState class that manages the BFS expansion data structures.

**Constructor:** Takes `ExpansionConfig` from types.ts.

**State properties (private):**
- `visited: Set<string>` — normalized topic texts already clicked
- `queue: ScoredTopic[]` — pending topics sorted by score desc
- `responses: Map<string, string>` — topic text -> response content
- `tree: Topic[]` — all topics encountered (for result reporting)
- `queriesUsed: number` — count of topics clicked this session
- `maxLevelReached: number` — deepest level expanded so far

**Methods:**
- `enqueue(topic: ScoredTopic): boolean` — Add topic to queue if not visited and score >= threshold. Returns true if added, false if duplicate/below-threshold. Maintain sort order (insert in correct position or re-sort).
- `dequeue(): ScoredTopic | null` — Pop highest-score topic from queue. Return null if queue empty.
- `markVisited(topicText: string): void` — Add normalized text to visited set, increment queriesUsed.
- `isVisited(topicText: string): boolean` — Check if normalized text is in visited set.
- `addResponse(topicText: string, response: string): void` — Store response, update maxLevelReached.
- `canContinue(): boolean` — Returns true if queue is not empty AND queriesUsed < config.maxQueries.
- `getResult(): ExpansionResult` — Build and return the ExpansionResult with all collected data.
- `getStats(): { queued: number, visited: number, responses: number, queriesUsed: number }` — Quick stats for logging.

Use `normalizeTopic` from topic-detector.ts for all text comparisons. Import it.

The queue sort is simple: `this.queue.sort((a, b) => b.score - a.score)` after each enqueue. No need for a heap — queue will rarely exceed 100 items.
  </action>
  <verify>`npx tsc --noEmit src/auto-conversation/expansion-state.ts` compiles</verify>
  <done>ExpansionState manages priority queue, visited set, response collection, and provides expansion statistics</done>
</task>

</tasks>

<verification>
- File compiles without TS errors
- ExpansionState exports single class
- Priority queue sorts by score descending
- Deduplication uses normalized topic text
- getResult() returns complete ExpansionResult
</verification>

<success_criteria>
ExpansionState provides all data management needed for the BFS expansion engine.
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-conversation-engine/02-04-SUMMARY.md`
</output>
