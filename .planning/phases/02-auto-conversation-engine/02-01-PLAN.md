---
phase: 02-auto-conversation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auto-conversation/types.ts
  - src/auto-conversation/topic-detector.ts
autonomous: true

must_haves:
  truths:
    - "TopicDetector finds all suggested topic pill texts from a NotebookLM page"
    - "Pill detection filters out non-topic buttons (send, copy, share, etc.)"
    - "Topic text is normalized for deduplication (lowercase, trimmed, trailing punctuation stripped)"
  artifacts:
    - path: "src/auto-conversation/types.ts"
      provides: "Topic, ScoredTopic, ExpansionConfig, ExpansionResult types"
      exports: ["Topic", "ScoredTopic", "ExpansionConfig", "ExpansionResult", "BudgetState"]
    - path: "src/auto-conversation/topic-detector.ts"
      provides: "TopicDetector class that finds suggested topic pills"
      exports: ["TopicDetector", "normalizeTopic"]
  key_links:
    - from: "src/auto-conversation/topic-detector.ts"
      to: "src/auto-conversation/types.ts"
      via: "import Topic type"
      pattern: "import.*types"
---

<objective>
Define all Phase 2 types and implement the TopicDetector that finds suggested topic pills in NotebookLM's UI.

Purpose: Types are the shared contract for all Phase 2 modules. TopicDetector is the first step of the expansion pipeline — finding what topics NotebookLM suggests.
Output: Types file and working TopicDetector class.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auto-conversation-engine/02-RESEARCH.md
@.planning/phases/01-browser-automation-foundation/01-04-SUMMARY.md
@src/browser/selectors.ts
@src/browser/humanize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Phase 2 types</name>
  <files>src/auto-conversation/types.ts</files>
  <action>
Create the shared types file for the auto-conversation module:

```typescript
interface Topic {
  text: string;
  level: number;
  parentTopic: string | null;
  score: number;
}

interface ScoredTopic extends Topic {
  reasoning: string;
  dimensions: {
    taskRelevance: number;    // 0-40
    errorRelevance: number;   // 0-30
    implementationValue: number; // 0-20
    novelty: number;          // 0-10
  };
}

interface ExpansionConfig {
  taskGoal: string;
  currentError: string | null;
  threshold: number;        // default 30
  maxLevel: number;         // default 10
  maxQueries: number;       // budget for this session
  model: string;            // default 'qwen2.5:1.5b'
}

interface ExpansionResult {
  responses: Map<string, string>;  // topic -> response
  topicsExpanded: number;
  topicsSkipped: number;
  queriesUsed: number;
  maxLevelReached: number;
  tree: Topic[];                   // full expansion tree
}

interface BudgetState {
  date: string;       // YYYY-MM-DD
  queriesUsed: number;
  limit: number;
}
```

Export all types. Use `export interface` (not `export type`).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/auto-conversation/types.ts`</verify>
  <done>All Phase 2 types defined and exported</done>
</task>

<task type="auto">
  <name>Task 2: TopicDetector implementation</name>
  <files>src/auto-conversation/topic-detector.ts</files>
  <action>
Create TopicDetector class that finds suggested topic pills on a NotebookLM page.

**Constructor:** Takes a Playwright `Page` instance.

**`detectPills(): Promise<string[]>`** — Core method:
1. Look for the suggested topic pills in NotebookLM's UI. Use Phase 1's selector registry if it has a selector for follow-up suggestions. Otherwise, use the heuristic from research: `page.getByRole('button')` filtered to text length 10-120 chars.
2. Filter out non-topic buttons using an exclude pattern: `/^(send|copy|share|like|dislike|submit|close|cancel|thumbs|menu|more|delete|edit|pin|save|download|upload|retry|regenerate|stop)/i`
3. Return array of pill text strings.

**`detectNewPills(visited: Set<string>): Promise<string[]>`** — Convenience method:
1. Call `detectPills()`
2. Filter out any pill whose `normalizeTopic(text)` is already in `visited`
3. Return only unseen pills.

**`normalizeTopic(text: string): string`** — Export as standalone function too:
1. `text.trim().toLowerCase()`
2. Strip trailing punctuation: `.replace(/[?.!,;:]+$/, '')`
3. Collapse multiple spaces: `.replace(/\s+/g, ' ')`

Add a 500ms delay between detection calls (use `randomDelay` from humanize utils) to avoid rapid DOM queries.

Import `Page` type from `playwright`. Import humanize utils from Phase 1.
  </action>
  <verify>`npx tsc --noEmit src/auto-conversation/topic-detector.ts` compiles. Manually verify the normalize function handles edge cases: trailing "?", multiple spaces, mixed case.</verify>
  <done>TopicDetector detects pills, filters non-topics, normalizes text, and identifies unseen pills</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for both files
- Types file exports all 6 interfaces
- TopicDetector exports class + normalizeTopic function
- normalizeTopic("  How Does X Work?  ") === "how does x work"
</verification>

<success_criteria>
Phase 2 type contracts defined. TopicDetector can find and normalize suggested topic pills from a NotebookLM page.
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-conversation-engine/02-01-SUMMARY.md`
</output>
