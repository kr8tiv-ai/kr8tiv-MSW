---
phase: 06-end-to-end-integration
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - tests/e2e/helpers/spawn-server.ts
  - tests/e2e/mcp-client.test.ts
  - vitest.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "E2E test spawns MCP server as child process and communicates via stdio"
    - "msw_init tool creates .msw/ directory when called through MCP protocol"
    - "msw_status returns valid status through full MCP round-trip"
    - "Tests clean up server process and temp directories after completion"
  artifacts:
    - path: "tests/e2e/helpers/spawn-server.ts"
      provides: "Test helper that spawns MCP server and returns SDK Client"
      exports: ["createTestClient"]
    - path: "tests/e2e/mcp-client.test.ts"
      provides: "E2E tests for MCP tool round-trips"
      contains: "msw_init"
    - path: "vitest.config.ts"
      provides: "Vitest configuration"
      contains: "vitest"
  key_links:
    - from: "tests/e2e/helpers/spawn-server.ts"
      to: "dist/mcp/index.js"
      via: "spawns as child process"
      pattern: "dist/mcp/index.js"
    - from: "tests/e2e/mcp-client.test.ts"
      to: "tests/e2e/helpers/spawn-server.ts"
      via: "imports createTestClient"
      pattern: "createTestClient"
---

<objective>
Create E2E test infrastructure and smoke tests that validate MCP tools work through the full stdio protocol.

Purpose: Validate the entire pipeline works end-to-end through real MCP protocol communication, not just unit-level imports.
Output: Test harness + E2E smoke tests for core MCP tools.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-end-to-end-integration/06-RESEARCH.md
@src/mcp/index.ts
@src/mcp/server.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vitest and create test harness</name>
  <files>package.json, vitest.config.ts, tests/e2e/helpers/spawn-server.ts</files>
  <action>
1. Run `npm install -D vitest` (skip execa, use MCP SDK's StdioClientTransport directly)
2. Create vitest.config.ts with:
   - test.include: ["tests/**/*.test.ts"]
   - test.testTimeout: 30000 (MCP server startup needs time)
3. Add `"test": "vitest run"` and `"test:watch": "vitest"` to package.json scripts
4. Create tests/e2e/helpers/spawn-server.ts:
   - Import Client from @modelcontextprotocol/sdk/client/index.js
   - Import StdioClientTransport from @modelcontextprotocol/sdk/client/stdio.js
   - createTestClient() function: creates StdioClientTransport with command "node" args ["dist/mcp/index.js"], creates Client, connects, returns { client, cleanup }
   - cleanup() closes client and kills child process
   - Ensure proper error handling if dist/ doesn't exist (throw clear message: "Run npm run build first")
  </action>
  <verify>Run `npm run build && npx vitest run --passWithNoTests` to confirm setup works.</verify>
  <done>Vitest configured, test harness spawns real MCP server process.</done>
</task>

<task type="auto">
  <name>Task 2: E2E smoke tests for MCP tools</name>
  <files>tests/e2e/mcp-client.test.ts</files>
  <action>
Create tests/e2e/mcp-client.test.ts:
1. Import createTestClient from helpers
2. Use os.tmpdir() + unique suffix for test projectDir
3. beforeAll: build check (assert dist/mcp/index.js exists), create test client
4. afterAll: cleanup client, remove temp directory
5. Tests:
   - "msw_init creates config": call msw_init with temp projectDir, assert response has success:true, assert .msw/config.json exists on disk
   - "msw_status returns status": call msw_status with projectDir, assert response contains status info
   - "msw_research returns job ID": call msw_research with topic, assert response contains jobId (research will likely fail without real browser, but should return gracefully)
   - "server lists all 7 tools": call client.listTools(), assert length >= 7, assert names include msw_init, msw_research, msw_plan, msw_execute, msw_verify, msw_status, msw_notebook_add
6. Each test should be independent (no ordering dependency)
7. Gate browser-dependent tests behind MSW_LIVE_TESTS env var check
  </action>
  <verify>Run `npm run build && npm test` â€” at least 3 tests pass (init, status, tool listing). Research test may gracefully report engine unavailable.</verify>
  <done>E2E tests validate MCP protocol round-trip for all core tools; CI-safe (no browser required for basic tests).</done>
</task>

</tasks>

<verification>
- `npm test` runs and passes (at minimum: init, status, tool listing tests)
- Server process cleans up after tests (no orphaned node processes)
- Tests use temp directories, no filesystem pollution
</verification>

<success_criteria>
E2E test suite validates MCP tools work through real stdio protocol. At least 3 smoke tests pass without requiring a browser.
</success_criteria>

<output>
After completion, create `.planning/phases/06-end-to-end-integration/06-03-SUMMARY.md`
</output>
