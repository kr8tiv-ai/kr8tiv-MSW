---
phase: 06-end-to-end-integration
plan: 04
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - src/pipeline/orchestrator.ts
  - src/mcp/tools/msw-init.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline orchestrator wires health check -> config validation -> state restore -> engine execution -> state save"
    - "msw_init validates config on startup and reports health status"
    - "Crash recovery: if state.json exists on init, pipeline resumes from last checkpoint"
  artifacts:
    - path: "src/pipeline/orchestrator.ts"
      provides: "Central pipeline coordinator with crash recovery"
      exports: ["PipelineOrchestrator"]
    - path: "src/mcp/tools/msw-init.ts"
      provides: "Enhanced init with config validation and health reporting"
      contains: "checkHealth"
  key_links:
    - from: "src/pipeline/orchestrator.ts"
      to: "src/pipeline/health.ts"
      via: "imports checkHealth"
      pattern: "checkHealth"
    - from: "src/pipeline/orchestrator.ts"
      to: "src/pipeline/state.ts"
      via: "imports saveCheckpoint, restoreCheckpoint"
      pattern: "restoreCheckpoint"
    - from: "src/pipeline/orchestrator.ts"
      to: "src/config/validator.ts"
      via: "imports loadConfig"
      pattern: "loadConfig"
---

<objective>
Create the pipeline orchestrator that ties health checks, config validation, and crash recovery into a coherent startup and execution flow.

Purpose: The individual modules (health, config, state) need a coordinator. The orchestrator manages the full lifecycle: validate config, check health, restore state if crashed, run pipeline, save state at checkpoints.
Output: PipelineOrchestrator class + enhanced msw_init with validation and health.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-end-to-end-integration/06-RESEARCH.md
@src/mcp/tools/msw-init.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pipeline orchestrator with crash recovery</name>
  <files>src/pipeline/orchestrator.ts</files>
  <action>
Create src/pipeline/orchestrator.ts:
1. Import loadConfig from ../config/validator.js
2. Import checkHealth from ./health.js
3. Import saveCheckpoint, restoreCheckpoint, clearCheckpoint from ./state.js
4. Class PipelineOrchestrator:
   - constructor(projectDir: string)
   - async initialize(): validates config, runs health check, attempts state restore
     - If state.json exists with phase != "idle", log "Resuming from checkpoint" and return restored state
     - If no state or phase == "idle", return fresh PipelineState
     - Returns { config, health, state, resumed: boolean }
   - async checkpoint(state: PipelineState): saves state to disk
   - async complete(): clears state file, marks pipeline idle
   - getHealth(): returns cached health results
   - getDegradedCapabilities(): returns list of what's unavailable based on health
5. Handle errors gracefully: if config invalid, throw with clear message; if health checks fail, continue with degraded mode (don't block startup)
  </action>
  <verify>Run `npm run check` to confirm types are correct.</verify>
  <done>PipelineOrchestrator coordinates config, health, and state lifecycle with crash recovery.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance msw_init with validation and health</name>
  <files>src/mcp/tools/msw-init.ts</files>
  <action>
Update msw-init.ts:
1. Import PipelineOrchestrator from ../../pipeline/orchestrator.js
2. After creating .msw/ directory and writing config:
   - Create PipelineOrchestrator with projectDir
   - Call orchestrator.initialize()
   - Include health check results in the response: { success, projectDir, configPath, config, health: [...], degraded: [...], resumed: false }
3. If orchestrator detects existing state.json (crash recovery):
   - Include resumed: true and the restored state phase in response
   - Log to stderr: "[msw] Resuming from previous session checkpoint"
4. If config validation fails, return isError: true with the zod error messages
5. Keep backwards compatibility: if config/validator modules fail to import, fall back to current behavior
  </action>
  <verify>Run `npm run check` to confirm types are correct.</verify>
  <done>msw_init validates config, reports health, and detects crash recovery state on startup.</done>
</task>

</tasks>

<verification>
- `npm run check` passes
- `npm run build` succeeds
</verification>

<success_criteria>
Pipeline orchestrator manages the full init lifecycle. msw_init reports health status and resumes from crashes.
</success_criteria>

<output>
After completion, create `.planning/phases/06-end-to-end-integration/06-04-SUMMARY.md`
</output>
