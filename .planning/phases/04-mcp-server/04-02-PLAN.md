---
phase: 04-mcp-server
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/jobs/types.ts
  - src/mcp/jobs/job-manager.ts
  - src/mcp/tools/registry.ts
autonomous: true

must_haves:
  truths:
    - "Jobs can be created, tracked, and polled by ID"
    - "Completed jobs are automatically cleaned up after TTL"
    - "Tool registration helper simplifies adding tools to the server"
  artifacts:
    - path: "src/mcp/jobs/types.ts"
      provides: "Job interface, JobStatus type, tool result types"
      exports: ["Job", "JobStatus", "ToolResult"]
    - path: "src/mcp/jobs/job-manager.ts"
      provides: "In-memory job queue with TTL cleanup"
      exports: ["JobManager"]
    - path: "src/mcp/tools/registry.ts"
      provides: "Helper to register tool groups on McpServer"
      exports: ["registerTools"]
  key_links:
    - from: "src/mcp/jobs/job-manager.ts"
      to: "src/mcp/jobs/types.ts"
      via: "imports Job interface"
      pattern: "import.*Job.*from.*types"
---

<objective>
Create the job manager for long-running operations and the tool registration infrastructure.

Purpose: Long-running tools (research, execute, plan) need to return job IDs immediately and be polled later. This plan builds the shared infrastructure before individual tools are implemented.
Output: JobManager class with create/get/update/cleanup, plus tool registration helper.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-mcp-server/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Job types and JobManager implementation</name>
  <files>src/mcp/jobs/types.ts, src/mcp/jobs/job-manager.ts</files>
  <action>
    Create `src/mcp/jobs/types.ts`:
    - `JobStatus` union type: "queued" | "running" | "completed" | "failed"
    - `Job` interface: id (string), tool (string), status (JobStatus), progress (optional {step, total, message}), result (unknown), error (string | undefined), createdAt (Date), updatedAt (Date)
    - `ToolResult` type for MCP tool responses: `{ content: Array<{type: "text", text: string}>, isError?: boolean }`

    Create `src/mcp/jobs/job-manager.ts`:
    - Class `JobManager` with private `jobs: Map<string, Job>`
    - `create(tool: string): Job` — creates job with randomUUID, status "queued", adds to map
    - `get(id: string): Job | undefined`
    - `update(id: string, patch: Partial<Job>): void` — updates fields + updatedAt
    - `list(): Job[]` — returns all jobs
    - `cleanup(ttlMs: number = 3600000): void` — removes completed/failed jobs older than TTL
    - Constructor starts a `setInterval` calling cleanup every 10 minutes
    - Export a singleton instance

    Use `import { randomUUID } from "node:crypto"` for IDs.
  </action>
  <verify>`npx tsc --noEmit src/mcp/jobs/job-manager.ts`</verify>
  <done>JobManager creates, tracks, updates, and cleans up jobs by ID</done>
</task>

<task type="auto">
  <name>Task 2: Tool registration helper</name>
  <files>src/mcp/tools/registry.ts</files>
  <action>
    Create `src/mcp/tools/registry.ts`:
    - Define a `ToolRegistrar` type: `(server: McpServer) => void`
    - Export `registerTools(server: McpServer, registrars: ToolRegistrar[]): void` that calls each registrar with the server
    - This keeps tool registration modular — each tool file exports a registrar function

    Import McpServer type from `@modelcontextprotocol/sdk/server/mcp.js`.
  </action>
  <verify>`npx tsc --noEmit src/mcp/tools/registry.ts`</verify>
  <done>registerTools helper accepts McpServer and array of tool registrar functions</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. All three files export their documented types/functions
</verification>

<success_criteria>
Job management infrastructure and tool registration pattern are ready for individual tool implementations.
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server/04-02-SUMMARY.md`
</output>
