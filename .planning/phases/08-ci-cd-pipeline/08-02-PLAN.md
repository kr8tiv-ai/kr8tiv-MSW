---
phase: 08-ci-cd-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/build.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "TypeScript type checking runs on every PR and commit"
    - "Build artifacts (dist/) are validated to be up-to-date"
    - "PRs with out-of-sync dist/ are automatically rejected"
  artifacts:
    - path: ".github/workflows/build.yml"
      provides: "Build validation workflow with check-dist pattern"
      contains: "check-dist"
      min_lines: 40
    - path: "package.json"
      provides: "Scripts for type checking and building"
      contains: '"check"'
  key_links:
    - from: ".github/workflows/build.yml"
      to: "npm run check"
      via: "TypeScript type checking step"
      pattern: "npm run check"
    - from: ".github/workflows/build.yml"
      to: "npm run build"
      via: "Build distribution step"
      pattern: "npm run build"
    - from: ".github/workflows/build.yml"
      to: "git status --porcelain dist/"
      via: "Verify dist/ is up-to-date"
      pattern: "git status.*dist/"
---

<objective>
Create build validation workflow to ensure TypeScript compiles successfully and dist/ artifacts remain synchronized with source code.

Purpose: Prevent broken builds from being merged and catch cases where developers forget to run `npm run build` before committing. Implements check-dist pattern to validate build artifacts.

Output: New build.yml workflow that runs TypeScript type checking, builds distribution, and verifies dist/ is up-to-date with source code, failing CI if discrepancies are found.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\PROJECT.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\ROADMAP.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\STATE.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\phases\08-ci-cd-pipeline\08-RESEARCH.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\package.json
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Create build validation workflow</name>
  <files>.github/workflows/build.yml</files>
  <action>
Create GitHub Actions workflow for TypeScript build validation using check-dist pattern:

**File: .github/workflows/build.yml**
- Name: Build Validation
- Triggers:
  - pull_request: branches [main, master]
  - push: branches [main, master]
- Job: build (ubuntu-latest)
- Steps:
  1. Checkout code: actions/checkout@v4
  2. Setup Node.js 20.x: actions/setup-node@v4 with cache: 'npm'
  3. Install dependencies: `npm ci`
  4. TypeScript type check: `npm run check`
  5. Build distribution: `npm run build`
  6. Verify dist/ is up-to-date (check-dist pattern):
     ```yaml
     - name: Verify dist/ is up-to-date
       run: |
         if [ -n "$(git status --porcelain dist/)" ]; then
           echo "::error::dist/ directory is out of sync with source. Run 'npm run build' locally and commit changes."
           git diff dist/
           exit 1
         fi
     ```
  7. Upload dist/ artifact on failure (actions/upload-artifact@v4):
     - if: failure()
     - name: expected-dist
     - path: dist/

Reference Pattern 3 from 08-RESEARCH.md for check-dist validation syntax.

Key behaviors:
- If TypeScript type check fails, workflow fails immediately
- If build fails, workflow fails immediately
- If build succeeds but dist/ has uncommitted changes, workflow fails with clear error message
- On failure, uploads what dist/ SHOULD contain for debugging
  </action>
  <verify>
cat .github/workflows/build.yml | grep "Build Validation"
cat .github/workflows/build.yml | grep "git status --porcelain dist/"
cat .github/workflows/build.yml | grep "actions/upload-artifact@v4"
  </verify>
  <done>Build workflow exists with TypeScript type check, build step, check-dist validation, and artifact upload on failure</done>
</task>

<task type="auto">
  <name>Verify package.json scripts exist</name>
  <files>package.json</files>
  <action>
Verify that required scripts exist in package.json (they should already exist based on 08-RESEARCH.md):

**Expected scripts:**
- "build": "tsc" (compile TypeScript to dist/)
- "check": "tsc --noEmit" (type check only, no output)

If these scripts are missing, add them. If they exist with different commands, document the difference but DO NOT change them (they may have project-specific configuration).

Current package.json shows:
- "build": "tsc" ✓ EXISTS
- "check": "tsc --noEmit" ✓ EXISTS

No changes needed, but verify they work correctly.
  </action>
  <verify>
npm run check 2>&1 | head -5
npm run build 2>&1 | head -5
ls dist/ 2>/dev/null | head -5 || echo "dist/ created by build"
  </verify>
  <done>package.json scripts (build, check) exist and execute successfully</done>
</task>

</tasks>

<verification>
1. Build workflow created with correct structure
2. TypeScript type checking runs via `npm run check`
3. Build runs via `npm run build`
4. Check-dist validation detects out-of-sync dist/ and fails CI
5. Artifact upload on failure provides debugging info
6. package.json scripts work correctly
</verification>

<success_criteria>
- TypeScript type checking runs on every PR (CI-03)
- Build verification ensures distribution artifacts are valid (CI-05)
- PRs with out-of-sync dist/ are rejected (CI-07 partial)
- Clear error messages guide developers to fix issues
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-cd-pipeline/08-02-SUMMARY.md`

**User Setup Required:**
After plan execution, configure GitHub branch protection rules to enforce all checks:
1. Go to repository Settings → Branches → Branch protection rules
2. Add rule for `main` (or `master`) branch
3. Enable "Require status checks to pass before merging"
4. Select required checks:
   - test / test (18.x)
   - test / test (20.x)
   - test / test (22.x)
   - build
   - lint
   - security / dependency-review
   - security / npm-audit
5. Enable "Require branches to be up to date before merging"
6. Save changes

This ensures CI-07 requirement: PRs cannot merge unless ALL checks pass.
</output>
