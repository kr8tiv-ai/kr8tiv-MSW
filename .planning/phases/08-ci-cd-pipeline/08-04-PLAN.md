---
phase: 08-ci-cd-pipeline
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - .github/workflows/security.yml
  - .github/workflows/test.yml
autonomous: true

must_haves:
  truths:
    - "Dependency vulnerabilities are scanned on every PR"
    - "Coverage regression is detected and reported on PRs"
    - "PRs introducing moderate+ vulnerabilities are rejected"
  artifacts:
    - path: ".github/workflows/security.yml"
      provides: "Security scanning workflow for dependencies"
      contains: "dependency-review-action"
    - path: ".github/workflows/test.yml"
      provides: "Enhanced test workflow with coverage regression detection"
      contains: "vitest-coverage-report-action"
  key_links:
    - from: ".github/workflows/security.yml"
      to: "actions/dependency-review-action@v4"
      via: "PR dependency scanning"
      pattern: "dependency-review-action"
    - from: ".github/workflows/security.yml"
      to: "npm audit"
      via: "Weekly vulnerability scanning"
      pattern: "npm audit"
---

<objective>
Add security scanning for dependency vulnerabilities and enhance coverage regression detection.

Purpose: Prevent merging PRs with vulnerable dependencies or coverage regressions. Uses GitHub's dependency-review-action for PR security checks and npm audit for scheduled scans.

Output: Security workflow with dependency-review-action (PR-based) and npm audit (scheduled), enhanced test.yml with vitest-coverage-report-action for coverage regression detection.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\PROJECT.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\ROADMAP.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\STATE.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\phases\08-ci-cd-pipeline\08-RESEARCH.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\phases\08-ci-cd-pipeline\08-01-PLAN.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.github\workflows\test.yml
</context>

<tasks>

<task type="auto">
  <name>Create security scanning workflow</name>
  <files>.github/workflows/security.yml</files>
  <action>
Create GitHub Actions workflow for dependency vulnerability scanning:

**File: .github/workflows/security.yml**
- Name: Security Scan
- Triggers:
  - pull_request: branches [main, master]
  - push: branches [main, master]
  - schedule: cron '0 0 * * 0' (weekly on Sunday at midnight UTC)
- Jobs:
  1. **dependency-review** (ubuntu-latest):
     - if: github.event_name == 'pull_request'
     - Steps:
       a. Checkout code: actions/checkout@v4
       b. Dependency Review: actions/dependency-review-action@v4
          - fail-on-severity: moderate
          - deny-licenses: GPL-2.0, GPL-3.0 (copyleft licenses that may conflict with MIT/ISC)

  2. **npm-audit** (ubuntu-latest):
     - Steps:
       a. Checkout code: actions/checkout@v4
       b. Setup Node.js 20.x: actions/setup-node@v4
       c. Run npm audit: `npm audit --audit-level=moderate`

Reference Pattern 6 from 08-RESEARCH.md for security workflow structure.

Key behaviors:
- dependency-review ONLY runs on PRs (compares PR changes to base branch)
- npm audit runs on all triggers (checks entire dependency tree)
- Fail on moderate+ severity vulnerabilities
- Scheduled weekly scans catch newly-disclosed CVEs
  </action>
  <verify>
cat .github/workflows/security.yml | grep "Security Scan"
cat .github/workflows/security.yml | grep "dependency-review-action@v4"
cat .github/workflows/security.yml | grep "npm audit"
cat .github/workflows/security.yml | grep "schedule:"
  </verify>
  <done>Security workflow exists with dependency-review-action (PR-based), npm audit (all triggers), and weekly schedule</done>
</task>

<task type="auto">
  <name>Verify coverage regression detection in test.yml</name>
  <files>.github/workflows/test.yml</files>
  <action>
Verify that test.yml (from 08-01-PLAN) has vitest-coverage-report-action configured correctly for coverage regression:

**Expected configuration in test.yml:**
```yaml
- name: Report coverage on PR
  if: github.event_name == 'pull_request' && matrix.node-version == '20.x'
  uses: davelosert/vitest-coverage-report-action@v2
  with:
    json-summary-path: ./coverage/coverage-summary.json
    json-final-path: ./coverage/coverage-final.json
    file-coverage-mode: changes
    vite-config-path: ./vitest.config.ts
```

This step should have been added by 08-01-PLAN. If missing, add it now (after Codecov upload step).

The `file-coverage-mode: changes` setting detects coverage regression on changed files and fails if coverage drops.

No changes needed if 08-01-PLAN was executed successfully.
  </action>
  <verify>
cat .github/workflows/test.yml | grep "vitest-coverage-report-action@v2"
cat .github/workflows/test.yml | grep "file-coverage-mode: changes"
  </verify>
  <done>test.yml has vitest-coverage-report-action with file-coverage-mode: changes for regression detection</done>
</task>

</tasks>

<verification>
1. Security workflow created with both dependency-review-action and npm audit
2. dependency-review-action runs only on PRs
3. npm audit runs on push, PR, and weekly schedule
4. Security workflow fails on moderate+ vulnerabilities
5. test.yml has coverage regression detection via vitest-coverage-report-action
</verification>

<success_criteria>
- Dependency vulnerabilities scanned on every PR (CI-09)
- PRs with moderate+ vulnerabilities are rejected (CI-07 partial)
- Coverage regression detected and reported on PRs (CI-08)
- Weekly security scans catch newly-disclosed CVEs (CI-09)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-cd-pipeline/08-04-SUMMARY.md`

**Note on License Denial:**
The security workflow denies GPL-2.0 and GPL-3.0 licenses to prevent copyleft contamination. If the project intentionally uses GPL dependencies, remove the `deny-licenses` configuration.
</output>
