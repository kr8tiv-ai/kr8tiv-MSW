---
phase: 08-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/test.yml
  - .github/workflows/e2e-health.yml
  - .github/actions/setup-node-with-cache/action.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions workflow runs tests on every commit and PR"
    - "Multi-Node version matrix (18, 20, 22) validates compatibility"
    - "E2E health checks run nightly against live NotebookLM"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "Enhanced test workflow with better coverage integration"
      contains: "vitest-coverage-report-action"
    - path: ".github/workflows/e2e-health.yml"
      provides: "Scheduled E2E health checks"
      contains: "workflow_dispatch"
    - path: ".github/actions/setup-node-with-cache/action.yml"
      provides: "Reusable Node.js setup composite action"
      exports: ["setup", "install"]
  key_links:
    - from: ".github/workflows/test.yml"
      to: "npm run test:coverage"
      via: "runs tests with coverage on every PR"
      pattern: "npm run test:coverage"
    - from: ".github/workflows/e2e-health.yml"
      to: "npm run test:e2e:health"
      via: "scheduled nightly E2E health check"
      pattern: "npm run test:e2e:health"
---

<objective>
Enhance existing GitHub Actions test workflow and add E2E health check automation.

Purpose: Improve CI/CD foundation with better coverage reporting, scheduled health checks against live NotebookLM, and reusable composite actions for workflow efficiency.

Output: Enhanced test.yml workflow using vitest-coverage-report-action for PR coverage comments with regression detection, new e2e-health.yml workflow for nightly NotebookLM validation, and composite action for Node.js setup to reduce duplication.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\PROJECT.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\ROADMAP.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\STATE.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.planning\phases\08-ci-cd-pipeline\08-RESEARCH.md
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\.github\workflows\test.yml
@C:\Users\lucid\OneDrive\Desktop\prompts\msw\package.json
</context>

<tasks>

<task type="auto">
  <name>Create composite action for Node.js setup</name>
  <files>.github/actions/setup-node-with-cache/action.yml</files>
  <action>
Create reusable composite action to reduce workflow duplication:

**File: .github/actions/setup-node-with-cache/action.yml**
- Name: 'Setup Node with Cache'
- Description: 'Setup Node.js with npm cache and install dependencies'
- Inputs:
  - node-version (required, default: '20.x'): Node.js version to use
- Steps:
  1. Setup Node.js using actions/setup-node@v4 with cache: 'npm'
  2. Run `npm ci` to install dependencies (use shell: bash for cross-platform compatibility)

Reference Pattern 8 from 08-RESEARCH.md for exact composite action syntax.
  </action>
  <verify>
ls .github/actions/setup-node-with-cache/action.yml
cat .github/actions/setup-node-with-cache/action.yml | grep "using: 'composite'"
  </verify>
  <done>Composite action exists and has correct structure with inputs, steps, and shell directives</done>
</task>

<task type="auto">
  <name>Enhance test.yml with vitest-coverage-report-action</name>
  <files>.github/workflows/test.yml</files>
  <action>
Update existing test workflow to use vitest-coverage-report-action for better PR coverage comments:

**Changes to .github/workflows/test.yml:**

1. KEEP existing structure:
   - Multi-Node matrix (18.x, 20.x, 22.x) - DO NOT CHANGE
   - Checkout, setup-node, npm ci, test:coverage - KEEP AS-IS
   - Coverage summary display step - KEEP AS-IS
   - Codecov upload (Node 20 only) - KEEP AS-IS

2. REPLACE lcov-reporter-action step with vitest-coverage-report-action:
   - Remove: romeovs/lcov-reporter-action@v0.3.1 step
   - Add (after Codecov upload, Node 20 only):
     ```yaml
     - name: Report coverage on PR
       if: github.event_name == 'pull_request' && matrix.node-version == '20.x'
       uses: davelosert/vitest-coverage-report-action@v2
       with:
         json-summary-path: ./coverage/coverage-summary.json
         json-final-path: ./coverage/coverage-final.json
         file-coverage-mode: changes
         vite-config-path: ./vitest.config.ts
     ```

3. Add fail-fast: false to matrix strategy (allows other Node versions to continue if one fails)

Reference Pattern 4 from 08-RESEARCH.md for vitest-coverage-report-action configuration.
  </action>
  <verify>
cat .github/workflows/test.yml | grep -A5 "vitest-coverage-report-action"
cat .github/workflows/test.yml | grep "fail-fast: false"
  </verify>
  <done>Test workflow uses vitest-coverage-report-action for PR comments, has fail-fast: false, and preserves existing Codecov integration</done>
</task>

<task type="auto">
  <name>Create E2E health check workflow</name>
  <files>.github/workflows/e2e-health.yml</files>
  <action>
Create scheduled workflow for nightly E2E validation against live NotebookLM:

**File: .github/workflows/e2e-health.yml**
- Name: E2E Health Check
- Triggers:
  - schedule: cron '0 2 * * *' (2 AM UTC daily)
  - workflow_dispatch: {} (allow manual trigger)
- Job: e2e-health (ubuntu-latest)
- Steps:
  1. Checkout code (actions/checkout@v4)
  2. Setup Node.js 20.x with cache
  3. Install dependencies: `npm ci`
  4. Install Playwright browsers: `npx playwright install --with-deps chromium`
  5. Run E2E health check: `npm run test:e2e:health`
     - Environment variables (use GitHub secrets):
       - NOTEBOOKLM_URL: ${{ secrets.NOTEBOOKLM_TEST_URL }}
  6. Upload Playwright traces on failure (actions/upload-artifact@v4)
     - name: playwright-traces
     - path: test-results/
     - if: failure()
  7. Create GitHub issue on failure (actions/github-script@v7)
     - if: failure()
     - Title: 'E2E Health Check Failed'
     - Body: Link to workflow run, note about potential NotebookLM UI changes
     - Labels: ['e2e-failure', 'automation']

Reference Pattern 5 from 08-RESEARCH.md for E2E health check workflow structure.

Note: GitHub secrets (NOTEBOOKLM_TEST_URL) will need to be configured manually by user. Document this in plan output.
  </action>
  <verify>
cat .github/workflows/e2e-health.yml | grep "schedule:"
cat .github/workflows/e2e-health.yml | grep "workflow_dispatch"
cat .github/workflows/e2e-health.yml | grep "github-script"
  </verify>
  <done>E2E health check workflow exists with scheduled trigger, manual dispatch, Playwright browser installation, and auto-issue creation on failure</done>
</task>

<task type="auto">
  <name>Add test:e2e:health script to package.json</name>
  <files>package.json</files>
  <action>
Add npm script for E2E health check (if not already exists):

**Changes to package.json scripts:**
```json
"test:e2e:health": "vitest run --config vitest.e2e.config.ts tests/e2e/health-check.test.ts"
```

Note: The actual test file `tests/e2e/health-check.test.ts` may not exist yet - that's OK. This script defines the interface for future E2E health tests. The workflow can be created now, and the test implementation can be added later when NotebookLM selectors are finalized.
  </action>
  <verify>
cat package.json | grep "test:e2e:health"
  </verify>
  <done>package.json has test:e2e:health script defined</done>
</task>

</tasks>

<verification>
1. Composite action created and has correct inputs/steps structure
2. test.yml workflow enhanced with vitest-coverage-report-action
3. E2E health check workflow created with schedule and manual dispatch
4. package.json has test:e2e:health script
5. All workflows use actions/checkout@v4 and actions/setup-node@v4 (latest stable versions)
</verification>

<success_criteria>
- GitHub Actions workflow runs tests on every commit and PR (CI-01)
- Multi-Node version matrix (18, 20, 22) validates compatibility (CI-02)
- Coverage reports include PR comments with regression detection (CI-08 partial)
- E2E health checks run nightly against live NotebookLM (CI-06)
- Composite action reduces workflow duplication
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-cd-pipeline/08-01-SUMMARY.md`

**User Setup Required:**
Before E2E health checks can run, configure GitHub secrets:
1. Go to repository Settings → Secrets and variables → Actions
2. Add secret: NOTEBOOKLM_TEST_URL (URL to test NotebookLM notebook)
3. Optionally add: NOTEBOOKLM_TEST_AUTH (if authentication state needed)

E2E health check will fail until secrets are configured, but workflow structure will be in place.
</output>
